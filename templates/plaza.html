<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>阅·峥嵘</title>
    <script src="{{ url_for('static', filename='assets/js/tailwindcss.min.js') }}"></script>
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/common.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='assets/css/plaza.css') }}">
</head>
<body class="page-body" style="background-image: url('static/images/bizhi6.jpg'); 
                                background-size: cover;
                                background-repeat: no-repeat;
                                background-attachment: fixed;">

    <div id="page-loader" class="page-loader">
        <div class="spinner"></div>
    </div>
    <!-- 统一导航栏 -->
    <div id="page-content">
        <nav class="nav-bar">
            <div class="nav-container">
                <div class="nav-content">
                    <div class="nav-logo-section">
                    <a href="/" class="nav-logo-link">
                        <img src="static/images/logo.png" alt="Logo" class="nav-logo-icon">
                        数智红韵网
                    </a>
                    </div>
                    <div class="nav-links-section">
                        <a href="/circle" class="nav-link">听·山河</a>
                        <a href="/making" class="nav-link">问·古今</a>
                        <a href="/plaza" class="nav-link-active" aria-current="page">阅·峥嵘</a>
                        <a href="/creation" class="nav-link">谱·华章</a>
                    </div>
                    <div class="nav-action-section">
                        <a href="/favorites" class="nav-favorite-link" title="我的收藏">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="currentColor" viewBox="0 0 24 24">
                                <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 5.42 4.42 3 7.5 3c1.74 0 3.41.81 4.5 2.09C13.09 3.81 14.76 3 16.5 3 19.58 3 22 5.42 22 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
                            </svg>
                        </a>

                        <!-- (新增) 登录/注册/欢迎您 模块 -->
                        <div id="auth-container" class="auth-container">
                            <!-- JS会在这里填充“登录/注册”按钮或“欢迎您, [用户名]” -->
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <div class="bookmark-wrapper">
            <div id="forum-bookmark" class="bookmark-pull" title="前往/返回 红歌论坛">
                <span class="bookmark-text">坛论</span>
                <svg class="bookmark-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 13l-7 7-7-7m14-8l-7 7-7-7" />
                </svg>
            </div>
        </div>

        <main class="main-content">
            <div class="main-container">
                <div class="content-card">
                    <div class="page-header-wrapper">
                        <h1 class="page-title">史海钩沉 · 薪火相传的历史画卷</h1>
                    </div>

                    <div class="plaza-grid">
                        <!-- 左侧：红歌微课 (应用了 plaza-card 样式) -->
                        <div class="module-card plaza-card module-article">
                            <div class="plaza-header">
                                <h2 class="plaza-title-text">
                                    <!-- 图标改为金色 -->
                                    <svg class="plaza-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6.253v13m0-13C10.832 5.477 9.246 5 7.5 5S4.168 5.477 3 6.253v13C4.168 18.477 5.754 18 7.5 18s3.332.477 4.5 1.253m0-13C13.168 5.477 14.754 5 16.5 5c1.747 0 3.332.477 4.5 1.253v13C19.832 18.477 18.247 18 16.5 18c-1.746 0-3.332.477-4.5 1.253" /></svg>
                                    AI红歌微课
                                </h2>
                            </div>
                            <div class="plaza-body">
                                <div id="article-list" class="article-list"></div>
                            </div>
                        </div>

                        <!-- 右侧：史实放映室 (应用了 plaza-card 样式) -->
                        <div class="module-card plaza-card module-timeline">
                             <div class="plaza-header">
                                <h2 class="plaza-title-text">
                                    <svg class="plaza-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                                    史实放映室
                                </h2>
                            </div>
                            <div class="plaza-body">
                                <div class="timeline">
                                    <div id="timeline" class="timeline-inner"></div>
                                </div>
                            </div>
                        </div>

                        <!-- 底部：红歌论坛 (应用了 plaza-card 样式) -->
                        <div id="forum-section" class="module-card plaza-card module-forum">
                            <div class="plaza-header">
                                <h2 class="plaza-title-text">
                                    <svg class="plaza-icon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 8h2a2 2 0 012 2v6a2 2 0 01-2 2h-2v4l-4-4H9a1.994 1.994 0 01-1.414-.586m0 0L11 14h4a2 2 0 002-2V6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2v4l.586-.586z" /></svg>
                                    红歌论坛
                                </h2>
                            </div>
                            <div class="plaza-body">
                                <div class="forum-container">
                                    <div class="forum-notice">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M18 10a8 8 0 11-16 0 8 8 0 0116 0zm-7-4a1 1 0 11-2 0 1 1 0 012 0zM9 9a1 1 0 000 2v3a1 1 0 001 1h1a1 1 0 100-2v-3a1 1 0 00-1-1H9z" clip-rule="evenodd" /></svg>
                                        <span><strong>公告：</strong> 论坛禁止发布违规、敏感话题，请文明交流。</span>
                                    </div>
                                    <div id="forum-posts" class="forum-posts"></div>
                                    <div class="forum-input-area">
                                        <textarea id="forum-content" class="forum-input" placeholder="在此留下您的感悟，与同道中人共话峥嵘岁月..."></textarea>
                                        <button id="forum-submit" class="forum-submit-btn">发布留言</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>
        <!-- 新增：视频播放器弹窗 -->
        <div id="video-modal" class="video-modal-overlay hidden">
            <div class="video-modal-content">
                <button id="close-video-modal" class="close-modal-button">&times;</button>
                <video id="video-player" class="video-player" controls>
                    <!-- 视频源将由JS动态设置 -->
                </video>
            </div>
        </div>
    </div>

    <!-- (新增) 登录/注册 弹窗 -->
    <div id="auth-modal-overlay" class="auth-modal-overlay hidden">
        <div id="auth-modal-content" class="auth-modal-content">
            <button id="auth-modal-close" class="auth-modal-close">&times;</button>
            
            <!-- 登录表单 -->
            <div id="login-form">
                <h2 class="auth-title">登录</h2>
                <div id="login-error" class="auth-error hidden"></div>
                <input type="text" id="login-username" placeholder="用户名" class="auth-input">
                <input type="password" id="login-password" placeholder="密码" class="auth-input">
                <button id="login-submit" class="auth-button">登录</button>
                <p class="auth-toggle">没有账户？ <a href="#" id="show-register">立即注册</a></p>
                <p class="auth-visitor-mode">
                    <a href="#" id="visitor-mode-button">以游客模式浏览</a>
                </p>
            </div>

            <!-- 注册表单 -->
            <div id="register-form" class="hidden">
                <h2 class="auth-title">注册</h2>
                <div id="register-error" class="auth-error hidden"></div>
                <input type="text" id="register-username" placeholder="设置用户名（不超过15个字符）" class="auth-input">
                <input type="password" id="register-password" placeholder="设置密码（需包含字母和数字）" class="auth-input">
                <input type="password" id="register-confirm-password" placeholder="确认密码" class="auth-input">
                <button id="register-submit" class="auth-button">注册并登录</button>
                <p class="auth-toggle">已有账户？ <a href="#" id="show-login">立即登录</a></p>
            </div>
        </div>
    </div>

    <!-- AI Guide (红小韵) -->
    <div id="ai-guide-mascot" class="ai-guide-mascot">
        <img src="{{ url_for('static', filename='images/hongxiaoyun.png') }}" alt="红小韵" class="ai-guide-image"/>
    </div>

    <div id="ai-guide-modal" class="ai-guide-modal hidden">
        <div class="guide-header flex justify-between items-center">
            <span>红韵向导 AI</span>
            <button id="guide-close" class="guide-close">&times;</button>
        </div>
        <div class="guide-messages" id="guide-messages">
            <div class="guide-message guide-response">
                <p>👋 <strong>您好！我是红小韵。</strong></p>
                <p>这里是<b>阅·峥嵘</b>，您需要了解微课或历史事件吗？</p>
            </div>
            <button class="guide-question-button" data-command="这个网站的功能是什么？">❓ 网站功能介绍</button>
            <button class="guide-question-button" data-command="我想搜索红歌">🎵 我想搜索红歌</button>
            <button class="guide-question-button" data-command="给我讲讲《东方红》的故事">📖 讲讲《东方红》的故事</button>
        </div>
        <div class="guide-input-area flex items-center gap-2">
            <input type="text" id="guide-input" class="guide-input" placeholder="输入指令..." />
            <button id="guide-send" class="guide-send-button">发送</button>
        </div>
    </div>

    <script src="{{ url_for('static', filename='assets/js/marked.min.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/common.js') }}"></script>
    <script src="{{ url_for('static', filename='assets/js/common_auth.js') }}"></script>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            fetch('/api/auth/status')
                .then(r => r.json())
                .then(data => {
                    if (data.logged_in) {
                        currentUserId = data.user_id;
                    }
                    // 必须在获取到 ID 后加载帖子
                    loadForumPosts();
                });

            // 2. 拉环书签逻辑 (修复)
            const bookmarkBtn = document.getElementById('forum-bookmark');
            const forumSection = document.getElementById('forum-section');
            let isExtended = false;
            let autoResetEnabled = true;  // 新增：是否允许自动复位

            function disableAutoReset(duration = 800) {
                autoResetEnabled = false;
                setTimeout(() => autoResetEnabled = true, duration);
            }

            bookmarkBtn.addEventListener('click', function () {
                if (!isExtended) {
                    // 展开
                    this.classList.add('extended');
                    this.querySelector('.bookmark-text').textContent = '返回';
                    isExtended = true;

                    disableAutoReset(); // 防止跳转时被自动复位

                    setTimeout(() => {
                        forumSection.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }, 100);

                } else {
                    // 收缩
                    this.classList.remove('extended');
                    this.querySelector('.bookmark-text').textContent = '坛论';
                    isExtended = false;

                    disableAutoReset(); // 同理，避免又被 scroll 监听影响

                    setTimeout(() => {
                        window.scrollTo({ top: 0, behavior: 'smooth' });
                    }, 50);
                }
            });

            window.addEventListener('scroll', function () {
                if (!autoResetEnabled) return; // 禁止自动复位时直接退出

                if (window.scrollY < 50 && isExtended) {
                    bookmarkBtn.classList.remove('extended');
                    bookmarkBtn.querySelector('.bookmark-text').textContent = '坛论';
                    isExtended = false;
                }
            });
            const articleList = document.getElementById('article-list');
            const timeline = document.getElementById('timeline');
            // 新增：获取视频弹窗相关元素
            const videoModal = document.getElementById('video-modal');
            const videoPlayer = document.getElementById('video-player');
            const closeVideoModal = document.getElementById('close-video-modal');
            // --- AI Guide 逻辑 ---
            const guideMascot = document.getElementById('ai-guide-mascot');
            const guideModal = document.getElementById('ai-guide-modal');
            const guideClose = document.getElementById('guide-close');
            const guideMessages = document.getElementById('guide-messages');
            const guideInput = document.getElementById('guide-input');
            const guideSend = document.getElementById('guide-send');

            // 注入 CSS
            const styleSheet = document.createElement("style");
            styleSheet.type = "text/css";
            styleSheet.innerText = `
                .spinner-small { width: 1rem; height: 1rem; border: 2px solid currentColor; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite; }
                @keyframes spin { to { transform: rotate(360deg); } }
            `;
            document.head.appendChild(styleSheet);

            function addGuideMessage(text, isUser = false, isMarkdown = false) {
                const msg = document.createElement('div');
                msg.className = 'guide-message';
                if (isUser) {
                    msg.innerHTML = `<p style="text-align: right; font-style: italic; color: #666;">我：${text}</p>`;
                } else {
                    msg.className += ' guide-response';
                    const contentDiv = document.createElement('div');
                    if (isMarkdown && typeof marked !== 'undefined') {
                        contentDiv.innerHTML = marked.parse(text);
                    } else {
                        contentDiv.innerHTML = `<p>${text}</p>`;
                    }
                    msg.appendChild(contentDiv);
                }
                guideMessages.appendChild(msg);
                guideMessages.scrollTop = guideMessages.scrollHeight;
                return msg;
            }
            
            function handleGuideCommand(query) {
                if (!query) return;
                guideInput.value = '';
                guideSend.disabled = true;
                addGuideMessage(query, true);
                const thinkingMsg = addGuideMessage("红小韵正在查阅资料...", false);
                thinkingMsg.innerHTML = `<p><div class="spinner-small" style="width:1rem; height:1rem; border-color:#fee2e2; border-top-color:var(--theme-red); margin: 0 0.5rem; display: inline-block;"></div> 红小韵正在查阅资料...</p>`;

                fetch('/api/guide/command', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ query: query })
                })
                .then(response => response.json())
                .then(data => {
                    thinkingMsg.remove();
                    if (data.action === 'navigate') {
                        const introText = data.intro_message || `好的，为您跳转到：**${data.label}**`;
                        addGuideMessage(introText, false, true);
                        const actionLink = document.createElement('a');
                        actionLink.className = 'guide-action-link';
                        actionLink.href = data.path;
                         actionLink.textContent = `👉 点击前往 ${data.label.replace('前往', '').replace('开始', '').replace('进入', '').replace('查看', '')}`;
                        
                        const linkMsg = document.createElement('div');
                        linkMsg.className = 'guide-message';
                        linkMsg.appendChild(actionLink);
                        guideMessages.appendChild(linkMsg);

                    } else if (data.action === 'text_response') {
                        // 文本回复也支持 Markdown
                        addGuideMessage(data.message, false, true);
                    } else {
                        addGuideMessage("抱歉，我没听懂您的指令。", false);
                    }
                })
                .catch(error => {
                    console.error("AI Guide Error:", error);
                    thinkingMsg.remove();
                    addGuideMessage("红小韵好像断线了，请稍后再试。", false);
                })
                .finally(() => {
                    guideSend.disabled = false;
                    guideMessages.scrollTop = guideMessages.scrollHeight;
                });
            }

            guideMascot.addEventListener('click', () => {
                guideModal.classList.toggle('hidden');
                if (!guideModal.classList.contains('hidden')) { guideMessages.scrollTop = guideMessages.scrollHeight; guideInput.focus(); }
            });
            guideClose.addEventListener('click', () => guideModal.classList.add('hidden'));
            document.querySelectorAll('.guide-question-button').forEach(button => {
                button.addEventListener('click', (e) => handleGuideCommand(e.target.dataset.command));
            });
            guideSend.addEventListener('click', () => handleGuideCommand(guideInput.value.trim()));
            guideInput.addEventListener('keypress', (e) => (e.key === 'Enter') && handleGuideCommand(guideInput.value.trim()));


            // 加载红歌微课
            fetch('/api/articles')
                .then(response => response.json())
                .then(data => {
                    // 保存文章数据供成就系统使用
                    articleList.dataset.articles = JSON.stringify(data.articles || []);
                    articleList.innerHTML = '';
                    if (data.articles && data.articles.length > 0) {
                        data.articles.forEach(article => {
                            const item = document.createElement('div');
                            item.className = 'article-item';
                            // 保存article ID用于成就系统
                            item.dataset.articleId = article.id;
                            
                            let playIconHTML = '';
                            if (article.video_url) {
                                item.dataset.videoUrl = article.video_url;
                                item.classList.add('is-clickable');
                                playIconHTML = `
                                    <div class="play-icon-wrapper">
                                        <svg class="play-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                                            <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM9.555 7.168A1 1 0 008 8v4a1 1 0 001.555.832l3-2a1 1 0 000-1.664l-3-2z" clip-rule="evenodd" />
                                        </svg>
                                    </div>
                                `;
                            }
                            
                            // 更新：将图标和标题包裹在一个新的容器中
                            item.innerHTML = `
                                <div class="article-content">
                                    <div class="article-header">
                                        ${playIconHTML}
                                        <h3 class="article-title">${article.title}</h3>
                                    </div>
                                    <p class="article-summary">${article.summary}</p>
                                </div>
                            `;
                            articleList.appendChild(item);
                        });

                        // --- 新增：自动播放 URL 参数指定的视频 ---
                        const urlParams = new URLSearchParams(window.location.search);
                        const targetId = urlParams.get('article_id');
                        if (targetId) {
                            const targetArticle = data.articles.find(a => String(a.id) === targetId);
                            if (targetArticle && targetArticle.video_url) {
                                // 稍微延迟一下，确保页面渲染完成体验更好
                                setTimeout(() => {
                                    videoPlayer.src = targetArticle.video_url;
                                    videoModal.classList.remove('hidden');
                                    videoPlayer.play().catch(e => console.log("Auto-play prevented:", e));
                                }, 500);
                            }
                        }
                    } else {
                        articleList.innerHTML = '<p class="empty-list-text">暂无微课内容。</p>';
                    }
                });
            
            // 新增：为微课列表添加点击事件委托
            articleList.addEventListener('click', function(event) {
                const clickedItem = event.target.closest('.article-item.is-clickable');
                if (clickedItem) {
                    const videoUrl = clickedItem.dataset.videoUrl;
                    if (videoUrl) {
                        videoPlayer.src = videoUrl;
                        videoModal.classList.remove('hidden');
                        videoPlayer.play();
                        
                        // 记录文章浏览并检查成就
                        const articleId = clickedItem.dataset.articleId;
                        if (articleId && currentUserId) {
                            fetch(`/api/articles/${articleId}/view`, {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                credentials: 'include'
                            })
                            .then(r => r.json())
                            .then(data => {
                                if (data.newly_unlocked && data.newly_unlocked.length > 0) {
                                    showAchievementNotification(data.newly_unlocked[0]);
                                }
                            })
                            .catch(console.error);
                        }
                    }
                }
            });

            // 新增：关闭弹窗的函数
            function closeModal() {
                videoModal.classList.add('hidden');
                videoPlayer.pause();
                videoPlayer.src = ''; // 停止加载视频
            }

            // 新增：为关闭按钮和背景遮罩添加关闭事件
            closeVideoModal.addEventListener('click', closeModal);
            videoModal.addEventListener('click', function(event) {
                // 如果点击的是背景遮罩本身，而不是其内部的内容
                if (event.target === videoModal) {
                    closeModal();
                }
            });

            // 加载史实时间轴
            fetch('/api/historical_events')
                .then(response => response.json())
                .then(data => {
                    timeline.innerHTML = '';
                    if (data.events && data.events.length > 0) {
                        data.events.forEach(event => {
                            const item = document.createElement('div');
                            item.className = 'timeline-item';
                            // 更新：移除了 timeline-chevron
                            item.innerHTML = `
                                <div class="timeline-dot"></div>
                                <div class="timeline-header">
                                    <h3 class="timeline-year">${event.year}</h3>
                                </div>
                                <p class="timeline-description">${event.event_description}</p>
                                ${event.detailed_description ? `
                                <div class="timeline-details">
                                    <p>${event.detailed_description}</p>
                                </div>
                                ` : ''}
                            `;
                            timeline.appendChild(item);
                        });
                    } else {
                        timeline.innerHTML = '<p class="empty-list-text">暂无历史事件。</p>';
                    }
                });

            // 更新：点击整个 timeline-item 来触发展开/折叠
            timeline.addEventListener('click', function(e) {
                const item = e.target.closest('.timeline-item');
                if (item) {
                    const details = item.querySelector('.timeline-details');
                    if (details) {
                        item.classList.toggle('is-expanded');
                    }
                }
            });

            const forumPosts = document.getElementById('forum-posts');
            const forumContent = document.getElementById('forum-content');
            const forumSubmit = document.getElementById('forum-submit');

            function loadForumPosts() {
                fetch('/api/forum/posts')
                .then(r => r.json())
                .then(data => {
                    forumPosts.innerHTML = '';
                    if (data.posts && data.posts.length > 0) {
                        data.posts.forEach(post => {
                            const div = document.createElement('div');
                            div.className = 'forum-post-item';
                            
                            // 判断本人
                            const showDelete = (currentUserId && post.user_id === currentUserId);
                            // 判断点赞
                            const heartClass = post.is_liked ? 'liked' : '';
                            const heartIcon = post.is_liked 
                                ? '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor"><path d="M11.645 20.91l-.007-.003-.022-.012a15.247 15.247 0 01-.383-.218 25.18 25.18 0 01-4.244-3.17C4.688 15.36 2.25 12.174 2.25 8.25 2.25 5.322 4.714 3 7.688 3A5.5 5.5 0 0112 5.052 5.5 5.5 0 0116.313 3c2.973 0 5.437 2.322 5.437 5.25 0 3.925-2.438 7.111-4.739 9.256a25.175 25.175 0 01-4.244 3.17 15.247 15.247 0 01-.383.219l-.022.012-.007.004-.003.001a.752.752 0 01-.704 0l-.003-.001z"/></svg>'
                                : '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M21 8.25c0-2.485-2.099-4.5-4.688-4.5-1.935 0-3.597 1.126-4.312 2.733-.715-1.607-2.377-2.733-4.313-2.733C5.1 3.75 3 5.765 3 8.25c0 7.22 9 12 9 12s9-4.78 9-12z" /></svg>';

                            div.innerHTML = `
                                <div class="post-main">
                                    <div class="post-header">
                                        <span class="post-user">
                                            <svg xmlns="http://www.w3.org/2000/svg" class="h-3 w-3" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M10 9a3 3 0 100-6 3 3 0 000 6zm-7 9a7 7 0 1114 0H3z" clip-rule="evenodd" /></svg>
                                            ${post.username}
                                        </span>
                                        <span class="post-time">${post.timestamp}</span>
                                    </div>
                                    <div class="post-content">${post.content}</div>
                                </div>
                                <div class="post-actions">
                                    <button class="post-like-btn ${heartClass}" data-id="${post.id}" title="点赞">
                                        ${heartIcon}
                                        <span class="like-count">${post.like_count}</span>
                                    </button>
                                    ${showDelete ? `<button class="post-delete-btn" data-id="${post.id}" title="删除">删除</button>` : ''}
                                </div>
                            `;
                            forumPosts.appendChild(div);
                        });

                        // 绑定点赞
                        document.querySelectorAll('.post-like-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                const postId = this.dataset.id;
                                fetch(`/api/forum/posts/like/${postId}`, { method: 'POST' })
                                .then(r => {
                                    if (r.status === 401) {
                                        document.getElementById('auth-modal-open')?.click();
                                        return null;
                                    }
                                    return r.json();
                                })
                                .then(d => {
                                    if(d && d.success) loadForumPosts(); 
                                });
                            });
                        });

                        // 绑定删除
                        document.querySelectorAll('.post-delete-btn').forEach(btn => {
                            btn.addEventListener('click', function() {
                                if(!confirm("确定删除这条留言吗？")) return;
                                const postId = this.dataset.id;
                                fetch(`/api/forum/posts/${postId}`, { method: 'DELETE' })
                                .then(r => r.json())
                                .then(d => {
                                    if(d.success) loadForumPosts();
                                    else alert(d.error);
                                });
                            });
                        });
                    } else {
                        forumPosts.innerHTML = '<p class="empty-list-text">暂无留言，快来抢沙发！</p>';
                    }
                });
            }

            forumSubmit.addEventListener('click', () => {
                const content = forumContent.value.trim();
                if (!content) return alert("请输入内容");
                
                fetch('/api/forum/posts', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ content: content })
                })
                .then(r => {
                    if (r.status === 401) {
                        document.getElementById('auth-modal-open')?.click();
                        throw new Error("请先登录");
                    }
                    return r.json();
                })
                .then(data => {
                    if (data.success) {
                        forumContent.value = '';
                        loadForumPosts();
                        // 检查是否解锁新成就
                        checkNewAchievements();
                    } else {
                        alert(data.error || "发布失败");
                    }
                })
                .catch(err => console.error(err));
            });

            // 检查新成就
            function checkNewAchievements() {
                fetch('/api/achievements/check', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' }
                })
                .then(r => r.json())
                .then(data => {
                    if (data.success && data.newly_unlocked && data.newly_unlocked.length > 0) {
                        // 显示成就解锁通知
                        showAchievementNotification(data.newly_unlocked[0]);
                    }
                })
                .catch(error => console.error('检查成就失败:', error));
            }

            // 显示成就解锁通知
            function showAchievementNotification(achievement) {
                const notification = document.createElement('div');
                notification.className = 'achievement-notification';
                notification.innerHTML = `
                    <div class="achievement-notification-content">
                        <span class="achievement-notification-icon">${achievement.icon}</span>
                        <div class="achievement-notification-text">
                            <span class="achievement-notification-title">成就解锁！</span>
                            <span class="achievement-notification-name">${achievement.name}</span>
                        </div>
                    </div>
                `;
                document.body.appendChild(notification);
                
                // 3秒后自动消失
                setTimeout(() => {
                    notification.classList.add('achievement-notification-hide');
                    setTimeout(() => notification.remove(), 300);
                }, 3000);
            }
        });
    </script>
</body>
</html>



